from segmentation_ui import SegmentationUI
from classification_ui import ClassificationUI
import tkinter as tk
from tkinter import ttk
from tkinter import filedialog, messagebox
from PIL import Image, ImageTk
import cv2
import os
import numpy as np

# Import cÃ¡c hÃ m xá»­ lÃ½ tá»« src (Backend)

from src.preprocessing.morphology.grayscale import apply_grayscale

from src.preprocessing.filters.gaussian_blur import apply_gaussian_blur
from src.preprocessing.filters.median_filter import apply_median_filter
from src.preprocessing.morphology.dilation import apply_dilation
from src.preprocessing.morphology.erosion import apply_erosion


class ImageProcessingApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Ứng dụng Xử lý ảnh - Digital Image Processing")
        self.root.geometry("1200x800")

        # Biáº¿n lÆ°u trá»¯ áº£nh (OpenCV format: BGR hoáº·c Grayscale)
        self.original_cv_image = None
        self.original_cv_image_backup = None  # Luu anh goc de reset
        self.processed_cv_image = None  # DÃ¹ng Ä‘á»ƒ lÆ°u vÃ  reset áº£nh
        self.mode_input_image = None  # Luu anh lam dau vao cho mode hien tai
        self.current_folder_path = ""
        self.current_mode = None
        self.image_path = None

        self.setup_ui()

    def setup_ui(self):
        # --- C?U H?NH LAYOUT (GRID) ---
        self.root.columnconfigure(0, weight=1)
        self.root.columnconfigure(1, weight=1)
        self.root.columnconfigure(2, weight=0)
        self.root.rowconfigure(0, weight=3)
        self.root.rowconfigure(1, weight=1)

        # --- 1. KHUNG ?NH G?C ---
        self.frame_original = tk.Frame(
            self.root, bg="#A9A9A9", bd=2, relief="sunken")
        self.frame_original.grid(
            row=0, column=0, sticky="nsew", padx=2, pady=2)
        tk.Label(self.frame_original, text="Ảnh Gốc (Original)",
                 bg="#A9A9A9", font=("Arial", 12, "bold")).pack(pady=5)
        self.lbl_original_img = tk.Label(self.frame_original, bg="#A9A9A9")
        self.lbl_original_img.pack(expand=True)

        # --- 2. KHUNG ?NH X? L? ---
        self.frame_processed = tk.Frame(
            self.root, bg="#808080", bd=2, relief="sunken")
        self.frame_processed.grid(
            row=0, column=1, sticky="nsew", padx=2, pady=2)
        tk.Label(self.frame_processed, text="Ảnh đang Xử lý (Result)",
                 bg="#808080", fg="white", font=("Arial", 12, "bold")).pack(pady=5)
        self.lbl_processed_img = tk.Label(self.frame_processed, bg="#808080")
        self.lbl_processed_img.pack(expand=True)

        # --- 3. KHUNG CH?C N?NG (B?NG ?I?U KHI?N) ---
        self.frame_controls = tk.Frame(self.root, bg="#5DADE2", width=250)
        self.frame_controls.grid(
            row=0, column=2, rowspan=2, sticky="nsew", padx=2, pady=2)
        self.frame_controls.pack_propagate(False)

        tk.Label(self.frame_controls, text="Chọn thuật toán:",
                 bg="#5DADE2").pack(pady=(10, 5))
        tk.Button(self.frame_controls, text="Grayscale", command=lambda: self.set_mode(
            "gray")).pack(fill="x", padx=20, pady=2)
        tk.Button(self.frame_controls, text="Gaussian Blur", command=lambda: self.set_mode(
            "gaussian")).pack(fill="x", padx=20, pady=2)
        tk.Button(self.frame_controls, text="Median Filter", command=lambda: self.set_mode(
            "median")).pack(fill="x", padx=20, pady=2)
        tk.Button(self.frame_controls, text="Dilation (Gi?n)", command=lambda: self.set_mode(
            "dilation")).pack(fill="x", padx=20, pady=2)
        tk.Button(self.frame_controls, text="Erosion (Co)", command=lambda: self.set_mode(
            "erosion")).pack(fill="x", padx=20, pady=2)
        
        # Slider ?i?u ch?nh tham s? (Kernel size)
        tk.Label(self.frame_controls, text="Chọn thuật toán:", f"KhÃ´ng thá»ƒ Ä‘á»c thÆ° má»¥c: {e}")
    def open_image(self):
        from tkinter import filedialog
        import cv2

        file_path = filedialog.askopenfilename(
            filetypes=[("Image files", "*.jpg *.png *.jpeg")]
        )

        if not file_path:
            return

        # âœ… LÆ¯U ÄÆ¯á»œNG DáºªN áº¢NH (CÃI Báº N ÄANG THIáº¾U)
        self.image_path = file_path

        # Load áº£nh
        self.original_image = cv2.imread(file_path)
        self.processed_image = self.original_image.copy()

        # Hiá»ƒn thá»‹ áº£nh
        self.display_image(self.original_image)
    def display_original(self, image_path):
        """Äá»c vÃ  hiá»ƒn thá»‹ áº£nh gá»‘c, Ä‘á»“ng thá»i reset áº£nh xá»­ lÃ½."""
        try:
            # Äá»c áº£nh báº±ng OpenCV
            self.original_cv_image = cv2.imread(image_path)
            self.original_cv_image_backup = self.original_cv_image.copy()
            # Khá»Ÿi táº¡o áº£nh xá»­ lÃ½ báº±ng cÃ¡ch sao chÃ©p áº£nh gá»‘c
            self.original_cv_image = self.original_cv_image_backup.copy()
            self.processed_cv_image = self.original_cv_image_backup.copy()
            self.mode_input_image = self.processed_cv_image.copy()

            # Convert BGR (OpenCV) to RGB (Pillow) Ä‘á»ƒ hiá»ƒn thá»‹
            img_rgb = cv2.cvtColor(self.original_cv_image, cv2.COLOR_BGR2RGB)

            # Hiá»ƒn thá»‹ áº£nh gá»‘c
            self.show_image_on_label(img_rgb, self.lbl_original_img)

            # Hiá»ƒn thá»‹ áº£nh xá»­ lÃ½ LÃ€M áº¢NH Gá»C (Tráº¡ng thÃ¡i chÆ°a xá»­ lÃ½)
            self.show_image_on_label(img_rgb, self.lbl_processed_img)

            # THAY Äá»”I CHÃNH: Reset cháº¿ Ä‘á»™ xá»­ lÃ½.
            # Loáº¡i bá» dÃ²ng tá»± Ä‘á»™ng gá»i process_image() á»Ÿ Ä‘Ã¢y.
            self.current_mode = None

            self.image_path = image_path


        except Exception as e:
            messagebox.showerror("Lá»—i hiá»ƒn thá»‹", f"KhÃ´ng thá»ƒ táº£i áº£nh: {e}")

    def reset_image(self):
        """Äáº·t láº¡i áº£nh Ä‘ang xá»­ lÃ½ thÃ nh áº£nh gá»‘c."""
        if self.original_cv_image_backup is not None:
            # Sao chÃ©p láº¡i áº£nh gá»‘c Ä‘á»ƒ reset
            self.original_cv_image = self.original_cv_image_backup.copy()
            self.processed_cv_image = self.original_cv_image_backup.copy()
            self.mode_input_image = self.processed_cv_image.copy()

            # Chuyá»ƒn Ä‘á»•i Ä‘á»ƒ hiá»ƒn thá»‹
            img_rgb = cv2.cvtColor(self.processed_cv_image, cv2.COLOR_BGR2RGB)
            self.show_image_on_label(img_rgb, self.lbl_processed_img)
            self.current_mode = None
            messagebox.showinfo("ThÃ´ng bÃ¡o", "ÄÃ£ reset áº£nh thÃ nh cÃ´ng.")
        else:
            messagebox.showwarning("Cáº£nh bÃ¡o", "KhÃ´ng cÃ³ áº£nh gá»‘c Ä‘á»ƒ reset.")

    
    def save_image_preprocessing(self):
        """LÆ°u áº£nh Ä‘Ã£ xá»­ lÃ½ vÃ o thÆ° má»¥c preprocessing."""
        if self.processed_cv_image is None:
            messagebox.showwarning("Cáº£nh bÃ¡o", "ChÆ°a cÃ³ áº£nh xá»­ lÃ½ Ä‘á»ƒ lÆ°u.")
            return

        save_dir = r"D:\Data\Python\digital-image-processing\archive\preprocessing"
        os.makedirs(save_dir, exist_ok=True)

        # Ä‘áº·t tÃªn file dá»±a trÃªn áº£nh gá»‘c (náº¿u cÃ³)
        if self.image_path:
            base_name = os.path.basename(self.image_path)
            name, ext = os.path.splitext(base_name)
            filename = f"{name}_preprocessed.png"
        else:
            filename = "preprocessed.png"

        save_path = os.path.join(save_dir, filename)

        # náº¿u áº£nh lÃ  RGB, chuyá»ƒn vá» BGR trÆ°á»›c khi lÆ°u báº±ng OpenCV
        img_to_save = self.processed_cv_image
        if len(img_to_save.shape) == 3 and img_to_save.shape[2] == 3:
            # giáº£ sá»­ Ä‘ang lÃ  BGR sáºµn tá»« OpenCV, náº¿u báº¡n Ä‘ang lÆ°u RGB thÃ¬ Ä‘á»•i láº¡i
            pass

        cv2.imwrite(save_path, img_to_save)
        messagebox.showinfo("ThÃ´ng bÃ¡o", f"ÄÃ£ lÆ°u áº£nh táº¡i:\n{save_path}")
    
    def show_image_on_label(self, cv_image_rgb, label_widget):
        h, w, _ = cv_image_rgb.shape

        # --- Sá»¬A Lá»–I á»ž ÄÃ‚Y ---
        # Láº¥y kÃ­ch thÆ°á»›c cá»§a Frame cha (Parent) chá»©a cÃ¡i Label Ä‘Ã³
        # Frame cha Ä‘Æ°á»£c set grid sticky="nsew" nÃªn kÃ­ch thÆ°á»›c nÃ³ sáº½ á»•n Ä‘á»‹nh
        parent_frame = label_widget.master

        frame_width = parent_frame.winfo_width()
        frame_height = parent_frame.winfo_height()

        # Fallback: Náº¿u chÆ°a render xong (kÃ­ch thÆ°á»›c = 1) thÃ¬ láº¥y máº·c Ä‘á»‹nh 400
        if frame_width < 100:
            frame_width = 400
        if frame_height < 100:
            frame_height = 400

        scale_w = frame_width / w
        scale_h = frame_height / h
        # Giáº£m 10% Ä‘á»ƒ táº¡o lá» thoÃ¡ng hÆ¡n chÃºt
        scale = min(scale_w, scale_h) * 0.90

        new_w = int(w * scale)
        new_h = int(h * scale)

        if new_w <= 0 or new_h <= 0:
            return

        img = Image.fromarray(cv_image_rgb)
        img = img.resize((new_w, new_h), Image.Resampling.LANCZOS)
        photo = ImageTk.PhotoImage(img)

        label_widget.config(image=photo)
        label_widget.image = photo

    def set_mode(self, mode):
        self.current_mode = mode
        if self.processed_cv_image is not None:
            self.mode_input_image = self.processed_cv_image.copy()
        elif self.original_cv_image is not None:
            self.mode_input_image = self.original_cv_image.copy()
        # Khi Ä‘á»•i ká»¹ thuáº­t, náº¿u Ä‘Ã£ cÃ³ áº£nh thÃ¬ preview trÃªn áº£nh hiá»‡n táº¡i
        if self.original_cv_image is not None:
            self.test_current_mode()

    def on_slider_change(self, val):
        if self.original_cv_image is not None and self.current_mode:
            self.test_current_mode()

    def process_image(self):
        self.test_current_mode()
    def _get_kernel_from_entry(self, entry_widget):
    
        k = int(entry_widget.get().strip())

        if k % 2 == 0:
            k += 1
        return k
    def batch_preprocess_folder(self):
        if not self.current_folder_path:
            messagebox.showwarning("Cáº£nh bÃ¡o", "Vui lÃ²ng chá»n thÆ° má»¥c áº£nh trÆ°á»›c!")
            return

        output_dir = r"D:\Data\Python\digital-image-processing\archive\preprocessing"
        os.makedirs(output_dir, exist_ok=True)

        valid_exts = (".jpg", ".jpeg", ".png", ".bmp")
        files = [f for f in os.listdir(self.current_folder_path)
                if f.lower().endswith(valid_exts)]

        if not files:
            messagebox.showwarning("ThÃ´ng bÃ¡o", "ThÆ° má»¥c khÃ´ng cÃ³ áº£nh há»£p lá»‡.")
            return

        # âœ… Láº¤Y KERNEL RIÃŠNG
        k_gaussian = self._get_kernel_from_entry(self.entry_k_gaussian)
        k_median   = self._get_kernel_from_entry(self.entry_k_median)
        k_dilation = self._get_kernel_from_entry(self.entry_k_dilation)
        k_erosion  = self._get_kernel_from_entry(self.entry_k_erosion)

        total = len(files)
        count = 0

        # âœ… RESET PROGRESS BAR
        self.batch_progress["value"] = 0
        self.batch_progress["maximum"] = total
        self.lbl_batch_percent.config(text="0%")
        self.root.update_idletasks()

        for i, fname in enumerate(files, start=1):
            in_path = os.path.join(self.current_folder_path, fname)
            img = cv2.imread(in_path)
            if img is None:
                continue

            # ===== PIPELINE =====
            if self.var_batch_gray.get():
                img = apply_grayscale(img)

            if self.var_batch_gaussian.get():
                img = apply_gaussian_blur(img, k_gaussian)

            if self.var_batch_median.get():
                img = apply_median_filter(img, k_median)

            if self.var_batch_dilation.get():
                img = apply_dilation(img, k_dilation)

            if self.var_batch_erosion.get():
                img = apply_erosion(img, k_erosion)

            name, _ = os.path.splitext(fname)
            out_path = os.path.join(output_dir, f"{name}_preprocessed.png")
            cv2.imwrite(out_path, img)
            count += 1

            # âœ… Cáº¬P NHáº¬T PROGRESS
            self.batch_progress["value"] = i
            percent = int((i / total) * 100)
            self.lbl_batch_percent.config(text=f"{percent}%")
            self.root.update_idletasks()

        messagebox.showinfo(
            "HoÃ n thÃ nh",
            f"ÄÃ£ xá»­ lÃ½ xong {count}/{total} áº£nh.\nLÆ°u táº¡i:\n{output_dir}"
        )
    def _apply_current_mode(self, commit=True):
        """Ap dung ky thuat dang chon len anh xu ly; commit=True se luu ket qua."""
        if self.original_cv_image is None or self.current_mode is None:
            return

        k_size = int(self.slider_kernel.get()) | 1

        if self.mode_input_image is None:
            if self.processed_cv_image is not None:
                self.mode_input_image = self.processed_cv_image.copy()
            else:
                self.mode_input_image = self.original_cv_image

        base = self.mode_input_image if self.mode_input_image is not None else self.original_cv_image

        temp = self._apply_mode(base.copy(), k_size)

        if commit:
            self.processed_cv_image = temp

        self._show_processed(temp)
    def test_current_mode(self):
        """Preview thu thuat tren anh hien tai va giu lai lam dau vao tiep theo."""
        self._apply_current_mode(commit=True)

    def apply_and_commit(self):
        """Ap dung thuat toan va luu lam dau vao cho lan ke tiep."""
        self._apply_current_mode(commit=True)

    def _apply_mode(self, img, k_size):
        if self.current_mode == "gray":
            return apply_grayscale(img)

        elif self.current_mode == "gaussian":
            return apply_gaussian_blur(img, k_size)

        elif self.current_mode == "median":
            return apply_median_filter(img, k_size)

        elif self.current_mode == "dilation":
            return apply_dilation(img, k_size)

        elif self.current_mode == "erosion":
            return apply_erosion(img, k_size)

        return img
    def _show_processed(self, img):
        if len(img.shape) == 2:
            display_rgb = cv2.cvtColor(img, cv2.COLOR_GRAY2RGB)
        else:
            display_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)

        self.show_image_on_label(display_rgb, self.lbl_processed_img)
